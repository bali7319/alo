# Zararlı Yazılım Temizleme (Alo17) - Safe-ish sürüm
# KRİTİK: Bu script sunucuda process kill + cron satırı temizleme + /tmp temizlik yapar.
# Hardcoded PID YOKTUR.
#
# Kullanım:
#   powershell -ExecutionPolicy Bypass -File .\scripts\security\CLEANUP_MALWARE.ps1
#   powershell -ExecutionPolicy Bypass -File .\scripts\security\CLEANUP_MALWARE.ps1 -Server "root@alo17.tr"
#

param(
  [string]$Server = "root@alo17.tr",
  [int]$Port = 22,
  [int]$ConnectTimeoutSec = 20,
  [switch]$AllowPasswordAuth
)

$ErrorActionPreference = "Continue"
$pattern = "xmrig|miner|crypto|stratum|kworker-0-0|vcHoibJV"

try {
  [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
  $OutputEncoding = [Console]::OutputEncoding
} catch {}

$sshBaseArgs = @(
  "-p", "$Port",
  "-o", ("BatchMode=" + ($(if ($AllowPasswordAuth.IsPresent) { "no" } else { "yes" }))),
  "-o", "ConnectTimeout=$ConnectTimeoutSec",
  "-o", "ServerAliveInterval=5",
  "-o", "ServerAliveCountMax=1"
)

function Invoke-RemoteBash {
  param([string]$Script)
  $Script | ssh @sshBaseArgs $Server "bash -s" 2>&1
}

Write-Host "==========================================" -ForegroundColor Red
Write-Host "MALWARE CLEANUP (SAFE-ISH)" -ForegroundColor Yellow
Write-Host "Target: $Server  Port: $Port" -ForegroundColor Yellow
Write-Host "==========================================" -ForegroundColor Red
Write-Host ""

Write-Host "0) Connectivity check..." -ForegroundColor Yellow
$ping = ssh @sshBaseArgs $Server "echo ok" 2>&1
if ($LASTEXITCODE -ne 0) {
  Write-Host $ping
  Write-Host ""
  Write-Host "SSH connection FAILED (timeout/refused). Cleanup cannot run until SSH is reachable." -ForegroundColor Red
  Write-Host "Use hosting panel console (KVM/VNC) to restore SSH/firewall or ask provider to open/whitelist port 22." -ForegroundColor White
  return
}

Write-Host "`n1. Şüpheli process'ler bulunuyor ve durduruluyor..." -ForegroundColor Yellow
Invoke-RemoteBash @"
set -e
echo '--- Suspect processes (before) ---'
ps aux | grep -Ei '$pattern' | grep -v grep || true
echo ''
PIDS=\$(ps aux | grep -Ei '$pattern' | grep -v grep | awk '{print \$2}' | tr '\n' ' ')
if [ -n "\$PIDS" ]; then
  echo "Killing PIDs: \$PIDS"
  kill -9 \$PIDS 2>/dev/null || true
else
  echo 'No matching processes found'
fi
echo ''
echo '--- Suspect processes (after) ---'
ps aux | grep -Ei '$pattern' | grep -v grep || true
"@

Write-Host "`n2. Root crontab şüpheli satırları temizleniyor..." -ForegroundColor Yellow
Invoke-RemoteBash @"
set -e
echo '--- root crontab (before) ---'
crontab -l 2>/dev/null || echo 'No root crontab'
TMP=\$(mktemp)
crontab -l 2>/dev/null | grep -Eiv '$pattern' > \$TMP || true
crontab \$TMP 2>/dev/null || true
rm -f \$TMP
echo ''
echo '--- root crontab (after) ---'
crontab -l 2>/dev/null || echo 'No root crontab'
"@

Write-Host "`n3. /tmp ve /var/tmp şüpheli dosyalar temizleniyor..." -ForegroundColor Yellow
Invoke-RemoteBash @"
set -e
echo '--- Finding (first 200) ---'
find /tmp /var/tmp -xdev \( -iname '*xmrig*' -o -iname '*miner*' -o -iname '*kworker*' -o -iname '*vchoibjv*' \) -print 2>/dev/null | head -200 || true
echo ''
echo '--- Deleting (best-effort) ---'
find /tmp /var/tmp -xdev \( -iname '*xmrig*' -o -iname '*miner*' -o -iname '*kworker*' -o -iname '*vchoibjv*' \) -print 2>/dev/null | xargs -r rm -rf 2>/dev/null || true
rm -rf /var/tmp/.cache/kworker-0-0 /tmp/.cache/kworker-0-0 2>/dev/null || true
echo 'tmp cleanup done.'
"@

Write-Host "`n4. Hızlı durum kontrol (CPU + network)..." -ForegroundColor Yellow
Invoke-RemoteBash @"
set -e
top -bn1 | head -15
echo '---'
ss -tpn state established 2>/dev/null | head -30 || netstat -tnp 2>/dev/null | head -30 || true
"@

Write-Host "`n==========================================" -ForegroundColor Red
Write-Host "CLEANUP COMPLETED" -ForegroundColor Green
Write-Host "`nHEMEN YAP (çok kritik):" -ForegroundColor Yellow
Write-Host "1) Root şifre + tüm kullanıcı şifreleri + DB şifreleri + .env secret rotate" -ForegroundColor Red
Write-Host "2) /root/.ssh/authorized_keys kontrol (bilinmeyen key varsa sil)" -ForegroundColor Red
Write-Host "3) Fail2ban + firewall + sistem güncellemesi" -ForegroundColor White
Write-Host "==========================================" -ForegroundColor Red

