# Bot mitigation (alo17)
# Focus: protect phone reveal endpoint from scrapers.
#
# Notes:
# - This is intentionally scoped to /api/listings/:id/reveal-phone only.
# - "Country" signal: uses Cloudflare's CF-IPCountry header if present.
#   If you're not behind Cloudflare, CF-IPCountry will be empty.

# Deny some obvious bad bots by UA (expand as needed)
if ($http_user_agent ~* (masscan|zgrab|sqlmap|nikto|acunetix|python-requests|curl/|wget/)) {
  return 444;
}

# Phone reveal endpoint: require Referer (most real browser clicks include it)
# Matches: /api/listings/:id/reveal-phone
location ~* ^/api/listings/[^/]+/reveal-phone$ {
  # Cross-site fetch signal (when provided)
  if ($http_sec_fetch_site ~* (cross-site|none)) { return 444; }

  # Referer empty â†’ block, but if CF-IPCountry says TR allow (reduces false positives)
  set $alo17_block_ref 0;
  if ($http_referer = "") { set $alo17_block_ref 1; }
  if ($http_cf_ipcountry = "TR") { set $alo17_block_ref 0; }
  if ($alo17_block_ref = 1) { return 444; }

  # Let Next.js handle auth/logic
  proxy_pass http://127.0.0.1:3000;
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
}

